---
title: ES文档索引过程
date: 2024-11-01 20:30:00 +0800
categories: [全文搜索,Elasticsearch]
tags: [elasticsearch]     
---
# ES文档索引过程
1. 客户端发起索引请求
2. 待索引文档存入ES**内存缓存区**且操作被记录到**translog**文件
![新文档被添加到内存缓冲区并附加到事务日志中.png](/assets/images/es/新文档被添加到内存缓冲区并附加到事务日志中.png)
3. 默认设置下translog文件在所有分片上完成提交并通过fsync刷新到磁盘（以为着数据已经完成持久化不会再丢失）后向客户端响应操作成功。
4. ES每隔一段时间会自动进行一次**refresh**操作此时缓存区会被提交（refresh_interval设置）
5. 缓存区被提交意味着缓存区中的所有数据被写入分片上的一个新的分段，新的分段首先被写入操作系统文件系统缓存且被打开，一旦进入文件系统缓存即可被正常打开使用。然后内存缓冲区会被清除但translog不清除。
6. 此时缓冲区的内容被写入了可搜索但未提交的段。
![refresh后缓冲区被清除但事务日志没有被清除.png](/assets/images/es/refresh后缓冲区被清除但事务日志没有被清除.png)
7. 如果此时es集群发生故障由于新段未完成提交和持久化节点重启时未提交的段会被删除，但是由于操作仍然记录在translog文件中，es会重放translog中的所有操作因此数据仍然不会丢失
8. 随着刷新操作被执行多次translog文件逐渐增大，当其变的太大时会触发一次flush操作，此时会创建新的translog文件并进行一次完全提交具体包含的动作如下：
   1. 内存缓冲区的数据写入新的分段
   2. 清除内存缓冲区
   3. 提交所有未提交的分段，持久化提交点数据，分段文件执行fsync写到磁盘
   4. 删除旧的translog
![完全提交后事务日志已清除.png](/assets/images/es/完全提交后事务日志已清除.png)