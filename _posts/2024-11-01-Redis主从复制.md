---
title: Redis主从复制功能
date: 2024-11-01 20:30:00 +0800
categories: [nosql, redis]
tags: [redis,nosql]     
---

# Redis主从复制功能

## 功能简介
多个Redis从节点(Replica)通过配置文件指定从单一一个主Redis节点(Master)复制数据以实现和和主节点保持数据相对一致。这里的主节点和从节点只是一个逻辑概念，任何一个Redis-server实例都可以作为主节点或从节点。

基于主从复制功能可实现Redis的高可用和故障转移。

## 配置示例
简单开启主从复制功能可以在从节点的redis.conf配置文件中通过replicaof配置来指定要复制的源节点（主节点）即可
```conf
replicaof 192.168.1.1 6379
```
复制功能的其他常用配置如下

| 配置                           | 说明                                                                                                                                                                                                                                              |
| ------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| masterauth \<master-password\> | 如果主节点通过requirepass设置了密码则从节点需要将此密码配置在此处                                                                                                                                                                                 |
| replica-read-only yes          | 配置从节点是否接受写请求，从Redis2.6开始从节点均默认只接受读请求                                                                                                                                                                                  |
| repl-backlog-size 1mb          | 配置复制backlog缓冲区大小。Master执行write命令后会将命令保存到backlog缓冲区中直至命令被所有slave确认或缓冲区容量超限后被驱逐。当slave重新连接到master时会检查待同步数据是否在backlog中，如果在则可通过backlog发送待同步数据以避免全量同步的发生。 |

完整配置请参考[redis.conf配置文件](https://raw.githubusercontent.com/redis/redis/unstable/redis.conf)

## 级联复制功能
Redis 的副本（replica）不仅可以连接到主节点（master），还可以互相连接形成级联结构。在 Redis 4.0 及更高版本中，所有的子副本都会从主节点接收相同的复制流，这意味着它们会接收到相同的数据更新。这种结构可以提高系统的可扩展性和容错能力。特别是当从节点数量较多时可以通过此方案降低主节点压力。

## 主从复制采用异步操作
- 在 Redis 中，主节点（Master）将写命令异步发送给从节点（Replica）。这意味着主节点在发送命令后不会等待从节点的确认，可以继续处理其他请求，提高了写入的吞吐量。
- 从节点在接收到写命令后，会执行这些命令并处理数据，但它不会立即向主节点发送确认（ACK）。相反，它会在内部记录下已处理的数据量，并在后续的时间间隔内向主节点发送批量确认信息。

## 主从复制流程
### 相关术语介绍
| 术语               | 说明                                                                                                                                                                                                                                         |
| ------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Replication ID     | Replication ID代表一组同步中Master节点数据集的标识，当一个节点被首次设置为Master或因故障转移被提升为Master时会新建Replication ID，其他从节点和Master节点握手后均会继承该Replication ID。所以本质上讲相同的Replication ID即代表了相同的数据集 |
| Replication offset | 上面提到不同节点具有相同Replication ID本质上是具有了相同的一套数据集，但是考虑到不同节点的复制进度不同因此只能说不同的从节点只是代表了这套相同数据集下不同时间点的状态，通过offset来表示。offset越大说明状态越和master一致                   |

### 复制流程
1. 正常情况系下Master执行write命令后会将相关命令通过socket同步给slave
2. 如果Slave因为某些原因端口连接后重新连接到Master时首先将自己本地记录的Replication ID和offset通过PSYNC命令发送给Master
3. Master判断Replication ID是否和自己的一致，如果一致offset是否和自己的差距较小。当这两个条件均满足时Master节点向Slaver发送尚未同步的增量数据，此种情况一般发生在Slaver因某些原因（服务器故障或网络分区等）断开连接后又很快自动重连成功时。由于Master会缓存最近一段时间的待复制数据（命令），当offset差距不大能在此范围内找到数据时可以直接根据这个缓存进行增量同步而不必进行全量同步
4. 如果上述第2点的两个条件无法全部满足则需要进行一次全量同步
   1. Master节点fork一个子进程来生成RDB文件
   2. 于此同时Master在主进程创建一个复制缓冲区（repl buffer）来保存新的写入命令
   3. 创建RDB文件完成后子进程结束。Master主进程负责将RDB文件发送给Slave
   4. 当Slave完整接受到RDB文件并加载完成后，Master 将复制缓冲区中的所有命令发送给Slave。此时slave和Master数据保持一致
5. 完成上述增量/全量同步后Master将继续执行第1步的常规复制流程

## 主从复制延迟状态检测
主节点可以使用 ROLE/INFO 命令查看与从节点之间的复制延迟。如果延迟过高，可能会影响系统的一致性和性能，管理员可以通过监控和调整来优化配置。

## wait指令的作用
```
WAIT numreplicas timeout
```
WAIT命令会阻塞当前客户端直至当前客户端连接在WAIT命令之前所发送的所有写入请求被至少numreplicas个slave确认接收到（注意至少确认接收到写入请求而不论是否写入成功）或超过timeout时间（timeout为0时代表永不超时）

由于只是确认了指定数量的slave接收到写入命令而不是写入成功，WAIT只能提高数据的一致性表现但无法确保。比如发生故障转移时仍然可能选举出未确认的从节点进而导致写入最终失败。

## 实际应用的场景
实际生产上一般不单独使用复制功能，更多的时候是结合sentinel和cluster来实现自动的故障转移。