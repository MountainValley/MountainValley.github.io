---
title: Spring @Transactional注解原理
date: 2025-01-05 22:49:20 +0800
categories: [Spring]
tags: [spring]     
---

@Transactional 是 Spring 框架中用于 声明式事务管理 的注解，它使开发者可以在方法或类上标注事务，而不需要手动管理事务的开启、提交或回滚。其实现原理主要基于 AOP（面向切面编程） 和 事务管理器（PlatformTransactionManager）。下面详细分解其原理：

一、@Transactional 的核心作用
在方法执行前开启事务，方法正常返回时提交事务，发生异常时回滚事务。

二、核心原理流程
1. 注解解析（事务属性提取）
Spring 容器启动时，会扫描被 @Transactional 注解标注的方法或类，通过 TransactionAttributeSource 接口提取事务属性，如：

传播行为（Propagation）

隔离级别（Isolation）

回滚策略（rollbackFor 等）

超时时间（timeout）

默认实现类是：

java
复制
编辑
org.springframework.transaction.annotation.AnnotationTransactionAttributeSource
2. AOP 代理创建
Spring 利用 AOP（一般使用 JDK 动态代理 或 CGLIB）生成代理类，拦截所有被 @Transactional 标注的方法。

关键类：

java
复制
编辑
org.springframework.transaction.interceptor.TransactionInterceptor
3. 方法拦截与事务控制
TransactionInterceptor 是一个 MethodInterceptor，其 invoke() 方法会执行如下流程：

java
复制
编辑
public Object invoke(MethodInvocation invocation) throws Throwable {
    // 获取事务属性（如传播行为）
    TransactionAttribute txAttr = getTransactionAttributeSource().getTransactionAttribute(method, targetClass);
    
    // 获取事务管理器
    PlatformTransactionManager tm = determineTransactionManager(txAttr);
    
    // 事务管理：开启、提交、回滚等
    TransactionInfo txInfo = createTransactionIfNecessary(tm, txAttr, methodIdentification);
    
    try {
        // 执行目标方法
        retVal = invocation.proceed();
    } catch (Throwable ex) {
        // 异常时进行回滚
        completeTransactionAfterThrowing(txInfo, ex);
        throw ex;
    } finally {
        // 清理资源
        cleanupTransactionInfo(txInfo);
    }

    // 正常执行时提交事务
    commitTransactionAfterReturning(txInfo);
    return retVal;
}
4. 事务传播与嵌套处理
事务传播行为（如 REQUIRED, REQUIRES_NEW, NESTED）由 AbstractPlatformTransactionManager 及其子类处理，如：

DataSourceTransactionManager（JDBC）

JpaTransactionManager（JPA）

HibernateTransactionManager（Hibernate）

三、PlatformTransactionManager 的作用
它是事务处理的核心接口，定义了：

getTransaction()：获取事务（可能新建或复用）

commit()：提交事务

rollback()：回滚事务

常见实现：

DataSourceTransactionManager：基于 JDBC 连接的事务管理

JpaTransactionManager：基于 JPA 的事务管理

HibernateTransactionManager：用于 Hibernate 的事务管理

四、关键注意点
代理对象调用自身内部方法不会生效（因为 Spring AOP 是基于代理的）。

解决方案：可以将方法拆分到不同 Bean 中，或者使用 AspectJ。

默认只在发生运行时异常（RuntimeException 或 Error）时才回滚。

可通过 rollbackFor = Exception.class 来指定其他类型异常。

事务只对公共方法有效（受限于 Spring AOP）。

五、简化总结
组件	作用
@Transactional	标记事务方法
TransactionInterceptor	拦截方法、处理事务
TransactionAttributeSource	解析注解属性
PlatformTransactionManager	执行事务操作（开启、提交、回滚）
AOP代理	**实现事务拦截**
