---
title: 分布式事务基础知识
date: 2024-12-12 10:30:00 +0800
categories: [微服务开发]
tags: [分布式事务,微服务,事务] 
---

## 分布式事务

传统关系型数据库提供了单机事务支持，可为同一数据库连接会话下的一组操作提供事务语义。保证了多个操作同时满足以下要求：
- A 原子性：多个操作同单个原子操作一样要么全部执行成功要么相当于全部未执行。
- C 一致性：事务执行前后数据一致性状态（约束）不会被破坏。比如转账业务中数据一致性指的是转账双方的账户之和不会改变。
- I 隔离性：事务隔离性确保每个事务在不受其他事务影响的独立环境中执行。
- D 持久性：事务提交后，数据即被持久化以防止丢失。

分布式微服务环境下一个用户操作可能涉及多个微服务协调处理。比如用户提交订单操作将影响库存服务、订单服务、账号服务、物流服务等多个服务的数据状态发生变更。如果无法在业务涉及的多个服务上实施全局事务保证将会带来一些列问题。

比如：用户A提交订单时首先通过库存服务进行库存预占，然后通过定单服务生成订单。假如此时订单服务发送异常不再可用，如果无法回滚库存服务的预占操作将导致这部分被预占的商品永远无法被售卖。

我们不妨先梳理一下传统单机事务ACID四个特性在分布式环境下面临的挑战。
- A 分布式环境下默认是无法提供原子性保证的，需要通过特殊的机制进行处理。原子性是分布式事务协议主要关注点。
- C 当同时满足A、I和D时数据一致性自然满足，无需特殊设计。
- I 分布式环境下的隔离性可以通过分布式锁来实现
- D 持久性依靠底层数据源支持

可见当业务在分布式环境下只需要保障隔离性时通过分布式锁即可实现。当需要保证分布式环境下的原子性时才需要使用分布式锁。

分布式事务涉及多个服务的协调，相对于单机事务来说会导致更长的资源锁定时间。因此实际开发中仅在确实需要时才考虑使用分布式事务，且应尽量避免长事务。

## 分布式事务常见方案
- **两阶段提交（2PC, Two-Phase Commit）**
  
  两阶段提交通过**事务协调器TC**管理分布式事务，确保参与的所有资源要么全成功要么全失败。
  
  - 阶段一（准备阶段/投票阶段）：协调器通知参与者**预提交**事务，资源管理器（RM）**执行操作但不提交**（如数据库保存到事务日志）。
  - 阶段二（提交阶段）：协调器根据第一阶段的结果：如果所有参与者都成功，通知参与者提交。如果任何参与者失败，通知参与者回滚。

- 3PC
  
  三阶段提交是两阶段提交的改进，增加了一个预提交阶段，降低阻塞风险。

  - 阶段一（CanCommit 阶段）：协调器询问所有参与者是否可以执行事务操作。
  - 阶段二（PreCommit 阶段）：如果所有参与者同意，执行预提交，进入“准备提交”状态。
  - 阶段三（DoCommit 阶段）：如果没有异常，协调器通知所有参与者提交；否则回滚。

- TCC
- 事务消息
- 本地消息表
- Saga

## 分布式事务具体实现
- XA
- Seata